{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para el buscador predictivo manual */
    #resultados_busqueda {
        max-height: 300px;
        overflow-y: auto;
        z-index: 1050; /* Por encima de todo */
        display: none; /* Oculto por defecto */
    }
    .item-resultado, .item-trabajador {
        cursor: pointer;
    }
    .item-resultado:hover, .item-trabajador:hover {
        background-color: #f8f9fa;
        color: #0d6efd;
    }
    .text-codigo { color: #0d6efd; } /* Azul estándar para el código */
    .item-resultado.active, .item-trabajador.active { background-color: #198754 !important; color: white !important; } /* Verde forzado */
    .item-resultado.active .text-codigo, .item-trabajador.active .text-codigo { color: white !important; } /* Forzar texto blanco al seleccionar */
    .item-resultado.active small, .item-trabajador.active small { color: #e0e0e0 !important; }
</style>
{% endblock %}

{% block header %}
    <a href="{% url 'inventario_list' %}" class="text-decoration-none text-muted fs-4 me-2"><i class="fas fa-arrow-left"></i></a>
    {{ titulo }}
{% endblock %}

{% block content %}
<form method="post">
    {% csrf_token %}
    
    <div class="card mb-4 border-top-primary shadow-sm">
        <div class="card-body bg-light">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase text-muted">Tipo Operación</label>
                    {{ form.tipo }}
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase text-muted">Requerimiento (Ref.)</label>
                    {{ form.requerimiento }}
                    <div class="form-text small text-muted">Opcional para Ingresos, Obligatorio para Salidas.</div>
                </div>

                {% if form.almacen_origen.is_hidden == False %}
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase text-muted">Almacén Origen</label>
                    {{ form.almacen_origen }}
                </div>
                {% endif %}
                
                {% if form.almacen_destino.is_hidden == False %}
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase text-muted">Almacén Destino</label>
                    {{ form.almacen_destino }}
                </div>
                {% endif %}

                {% if form.trabajador.is_hidden == False %}
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase text-info">Trabajador (Solicitante)</label>
                    <div class="input-group position-relative">
                        <span class="input-group-text bg-info text-white"><i class="fas fa-hard-hat"></i></span>
                        
                        <!-- Input Visual de Búsqueda -->
                        <input type="text" id="input_buscar_trabajador" class="form-control" placeholder="Buscar por DNI, Nombre..." autocomplete="off">
                        
                        <!-- Select Original Oculto (Mantiene la lógica de Django) -->
                        <div class="d-none">{{ form.trabajador }}</div>

                        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modalNuevoTrabajador" title="Registrar Nuevo Trabajador">
                            <i class="fas fa-plus"></i>
                        </button>
                        <!-- Lista de Resultados Flotante -->
                        <div id="resultados_trabajador" class="list-group position-absolute w-100 shadow start-0" style="top: 100%; z-index: 1050; display: none; max-height: 250px; overflow-y: auto;"></div>
                    </div>
                </div>
                {% endif %}

                {% if form.torre_destino.is_hidden == False %}
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase text-primary">Torre Destino</label>
                    <div class="input-group">
                        <span class="input-group-text bg-primary text-white"><i class="fas fa-building"></i></span>
                        {{ form.torre_destino }}
                    </div>
                </div>
                {% endif %}
            </div>

            <hr class="my-3 text-muted opacity-25">

            <div class="row">
                <div class="col-md-4">
                    {% if 'SALIDA' in titulo|upper or 'CONSUMO' in titulo|upper or 'SALIDA' in form.tipo.value %}
                        <label class="form-label fw-bold small text-primary">N° VALE SALIDA</label>
                        <div class="input-group">
                            <span class="input-group-text bg-primary text-white border-primary">
                                <i class="fas fa-file-export"></i>
                            </span>
                            {{ form.nota_ingreso }}
                        </div>
                        <div class="form-text small mt-1 text-primary">
                            <i class="fas fa-info-circle"></i> Se generará ej: <strong>VS-000X</strong>
                        </div>
                    {% else %}
                        <label class="form-label fw-bold small text-success">N° NOTA INGRESO</label>
                        <div class="input-group">
                            <span class="input-group-text bg-success text-white border-success">
                                <i class="fas fa-barcode"></i>
                            </span>
                            {{ form.nota_ingreso }}
                        </div>
                        <div class="form-text small mt-1 text-success">
                            <i class="fas fa-info-circle"></i> Se generará ej: <strong>NI-000X</strong>
                        </div>
                    {% endif %}
                </div>

                <div class="col-md-5">
                    <label class="form-label fw-bold small text-dark">N° GUÍA / FACTURA</label>
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-file-invoice"></i>
                        </span>
                        {{ form.documento_referencia }}
                    </div>
                </div>
            </div>
            
            {% for field in form %}
                {% if field.is_hidden %}{{ field }}{% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="card mb-4 shadow">
        <div class="card-header bg-dark text-white">
            <i class="fas fa-boxes me-1"></i> Detalle de Materiales
        </div>
        
        <!-- BUSCADOR CENTRAL (AUTOFILTRO) -->
        <div class="card-body bg-light border-bottom p-3">
            <label class="form-label fw-bold text-primary mb-1"><i class="fas fa-search me-1"></i> Buscar y Agregar Material:</label>
            <div class="position-relative">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" id="input_buscar_material" class="form-control" placeholder="Escriba código o nombre del material..." autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" id="btn_limpiar_busqueda"><i class="fas fa-times"></i></button>
                </div>
                <!-- Lista de resultados flotante -->
                <div id="resultados_busqueda" class="list-group position-absolute w-100 shadow border-top-0"></div>
            </div>
        </div>

        <div class="card-body p-0">
            {{ formset.management_form }}
            <table class="table table-striped mb-0" id="items-table">
                <thead>
                    <tr>
                        <th width="25%">Material</th>
                        <th width="8%">Cant.</th>
                        <th width="10%">Costo (S/.)</th>
                        <th width="12%" class="col-ingreso">Marca</th>
                        <th width="15%" class="col-ingreso">Series</th>
                        <th width="27%" class="col-salida" style="display:none;">Activo (Serie)</th>
                        <th width="20%">Asignar a Req. / Stock Libre</th>
                        <th width="10%"></th>
                    </tr>
                </thead>
                <tbody id="form-list">
                    {% for form in formset %}
                    <tr class="item-row">
                        {{ form.id }}
                        {{ form.material }} <!-- Input Oculto con el ID -->
                        <td>
                            <!-- Texto visible solo para lectura -->
                            <div class="fw-bold material-nombre">
                                {% if form.instance.pk or form.instance.material %}
                                    {{ form.instance.material.codigo }} - {{ form.instance.material.descripcion }}
                                {% endif %}
                            </div>
                            <div class="small text-muted material-unidad">
                                {% if form.instance.pk or form.instance.material %}
                                    {{ form.instance.material.unidad_medida }}
                                {% endif %}
                            </div>
                        </td>
                        <td>{{ form.cantidad }}</td>
                        <td>{{ form.costo_unitario }}</td>
                        <td class="col-ingreso">{{ form.marca }}</td>
                        <td class="col-ingreso">{{ form.series_temporales }}</td>
                        <td class="col-salida" style="display:none;">{{ form.activo }}</td>
                        <td>{{ form.seleccion_requerimiento }}</td>
                        <td class="text-center align-middle">
                            <div class="d-none">{{ form.DELETE }}</div> <!-- Checkbox oculto de Django -->
                            <button type="button" class="btn btn-outline-danger btn-sm btn-eliminar-fila" title="Eliminar fila"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                    {% if form.errors %}
                    <tr class="error-row"><td colspan="6" class="text-danger small bg-danger bg-opacity-10"><i class="fas fa-exclamation-triangle me-1"></i> {{ form.errors }}</td></tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Mensaje si la tabla está vacía -->
            <div id="empty-message" class="text-center py-4 text-muted {% if formset|length > 0 %}d-none{% endif %}">
                <i class="fas fa-arrow-up mb-2"></i><br>
                Utilice el buscador de arriba para agregar materiales.
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button type="submit" class="btn btn-success btn-lg px-5">
            <i class="fas fa-check-circle me-2"></i> {{ boton_texto }}
        </button>
    </div>
</form>

<!-- MODAL NUEVO TRABAJADOR (ALTA RÁPIDA) -->
<div class="modal fade" id="modalNuevoTrabajador" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Nuevo Trabajador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-quick-trabajador">
                    <div class="mb-3">
                        <label class="form-label">DNI *</label>
                        <input type="text" class="form-control" name="dni" required pattern="\d{8}" maxlength="8" minlength="8" title="Debe contener exactamente 8 dígitos numéricos" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="Ej: 12345678">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombres *</label>
                            <input type="text" class="form-control" name="nombres" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellidos *</label>
                            <input type="text" class="form-control" name="apellidos" required>
                        </div>
                    </div>
                    <div id="msg-error-trabajador" class="alert alert-danger d-none small"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-info text-white" id="btn-save-trabajador">Guardar y Seleccionar</button>
            </div>
        </div>
    </div>
</div>

<!-- TOAST DE NOTIFICACIÓN -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="liveToast" class="toast align-items-center text-white bg-success border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fw-bold" id="toast-message">
                <!-- Mensaje dinámico -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<div id="empty-form" style="display:none;">
    <table>
        <tr class="item-row">
            {{ formset.empty_form.id }}
            {{ formset.empty_form.material }}
            <td>
                <!-- Placeholders para JS -->
                <div class="fw-bold material-nombre"></div>
                <div class="small text-muted material-unidad"></div>
            </td>
            <td>{{ formset.empty_form.cantidad }}</td>
            <td>{{ formset.empty_form.costo_unitario }}</td>
            <td class="col-ingreso">{{ formset.empty_form.marca }}</td>
            <td class="col-ingreso">{{ formset.empty_form.series_temporales }}</td>
            <td class="col-salida" style="display:none;">{{ formset.empty_form.activo }}</td>
            <td>{{ formset.empty_form.seleccion_requerimiento }}</td>
            <td class="text-center align-middle">
                <div class="d-none">{{ formset.empty_form.DELETE }}</div>
                <button type="button" class="btn btn-outline-danger btn-sm btn-eliminar-fila"><i class="fas fa-trash-alt"></i></button>
            </td>
        </tr>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
    // --- VARIABLES GLOBALES ---
    const ALMACEN_ID_URL = "{{ almacen.id }}"; // El almacén en el que estamos parados
    const TIPO_ACCION = "{{ titulo }}".toUpperCase(); // Para saber si entramos a INGRESO o SALIDA

    // Mapa de validación: { 'uuid_req': ['uuid_mat1', 'uuid_mat2'] }
    const REQS_MATERIALES = JSON.parse('{{ reqs_materiales_json|escapejs }}');

    // Mapa inverso: { 'uuid_mat': ['uuid_req1', 'uuid_req2'] }
    const MATS_REQS = JSON.parse('{{ mats_reqs_json|escapejs }}');

    // Mapa de Tipos: { 'uuid_mat': 'ACTIVO_FIJO' | 'CONSUMIBLE' }
    const TIPOS_MATERIALES = JSON.parse('{{ materiales_tipos_json|escapejs }}');

    // --- CARGAR MATERIALES EN MEMORIA (Para búsqueda rápida sin plugins) ---
    const MATERIALES_DISPONIBLES = [
        {% for material in materiales_disponibles %}
        {
            id: "{{ material.id }}",
            texto: "{{ material.codigo }} - {{ material.descripcion|escapejs }}",
            unidad: "{{ material.unidad_medida }}",
            codigo: "{{ material.codigo }}"
        },
        {% endfor %}
    ];

    function toggleCampos() {
        // Obtenemos el texto de la opción seleccionada
        let tipoTexto = $('#id_tipo option:selected').text().toUpperCase();
        let tipoValor = $('#id_tipo').val();

        // ELEMENTOS DEL DOM (Los contenedores col-md-4)
        let divOrigen = $('#id_almacen_origen').closest('.col-md-4');
        let divDestino = $('#id_almacen_destino').closest('.col-md-4');
        let divTorre = $('#id_torre_destino').closest('.col-md-4');
        let divTrabajador = $('#id_trabajador').closest('.col-md-4');
        let labelTrabajador = divTrabajador.find('label');

        // LÓGICA DE VISIBILIDAD
        if (tipoTexto.includes('INGRESO') || tipoTexto.includes('DEVOLUCION') || tipoTexto.includes('ENTRADA')) {
            // === ES UN INGRESO ===
            // 1. Origen: Se oculta (viene de proveedor externo)
            divOrigen.hide(); 
            
            // 2. Destino: Se muestra (es donde entra)
            divDestino.show();
            // Truco: Seteamos el destino como el almacén actual si está vacío
            if(!$('#id_almacen_destino').val()) {
                $('#id_almacen_destino').val(ALMACEN_ID_URL).trigger('change');
            }

            // 3. Torre: Se oculta
            divTorre.hide();
            $('#id_torre_destino').val(null).trigger('change');
            
            // Mostrar trabajador también en ingresos (para Devoluciones o Responsable de Recepción)
            divTrabajador.show();
            if (tipoTexto.includes('DEVOLUCION')) {
                labelTrabajador.text('Trabajador (Devuelve)');
            } else {
                labelTrabajador.text('Trabajador (Recepciona/Solicita)');
            }
            
            // Ajuste de columnas de tabla
            $('.col-ingreso').show();
            $('.col-salida').hide();
            // Ajustar anchos si es necesario
            $('th.col-ingreso').first().attr('width', '12%');
            $('th.col-ingreso').last().attr('width', '15%');
            $('th.col-salida').attr('width', '0%');

        } else if (tipoTexto.includes('SALIDA') || tipoTexto.includes('CONSUMO')) {
            // === ES UNA SALIDA ===
            // 1. Origen: Se muestra (sale de aquí)
            divOrigen.show();
            if(!$('#id_almacen_origen').val()) {
                $('#id_almacen_origen').val(ALMACEN_ID_URL).trigger('change');
            }

            // 2. Destino: Se oculta (porque va a una Torre, no a otro almacén)
            divDestino.hide();
            $('#id_almacen_destino').val(null).trigger('change');

            // 3. Torre vs Trabajador (Siempre mostramos Trabajador en salidas)
            divTrabajador.show();
            labelTrabajador.text('Trabajador (Solicitante)');

            if (tipoTexto.includes('EPP')) {
                divTorre.hide();
                $('#id_torre_destino').val(null).trigger('change');
            } else if (tipoTexto.includes('OFICINA')) {
                divTorre.hide();
                $('#id_torre_destino').val(null).trigger('change');
            } else {
                // SALIDA OBRA
                divTorre.show();
            }
            
            // Ajuste de columnas de tabla
            $('.col-ingreso').hide();
            $('.col-salida').show();
            $('th.col-ingreso').attr('width', '0%');
            $('th.col-salida').attr('width', '27%');


        } else if (tipoTexto.includes('TRANSFERENCIA')) {
            // === ES TRANSFERENCIA ===
            divOrigen.show();
            divDestino.show();
            divTorre.hide();
            divTrabajador.hide();
        }
    }

    // --- LÓGICA DE VALIDACIÓN DE STOCK ---
    function validarStockFila(row) {
        const ALMACEN_ACTUAL = $('#id_almacen_origen').val() || ALMACEN_ID_URL;
        // Adaptación para input oculto (Buscador Central)
        let materialInput = row.find('input[name$="-material"]');
        let cantidadInput = row.find('input[type="number"]').first(); 
        let materialId = materialInput.val();
        let cantidadSolicitada = parseFloat(cantidadInput.val()) || 0;

        cantidadInput.removeClass('is-invalid');
        row.find('.stock-error').remove();
        $('button[type="submit"]').prop('disabled', false); 

        // Solo validamos stock si es SALIDA
        let esSalida = $('#id_tipo option:selected').text().toUpperCase().includes('SALIDA');
        
        if (!esSalida || !materialId || !ALMACEN_ACTUAL) return;

        let url = `/logistica/api/stock/${ALMACEN_ACTUAL}/${materialId}/`;

        $.get(url, function(data) {
            let stockDisponible = parseFloat(data.stock);
            if (cantidadSolicitada > stockDisponible) {
                cantidadInput.addClass('is-invalid');
                let mensaje = `<div class="invalid-feedback stock-error d-block">
                                    <strong>¡Stock Insuficiente!</strong> Máx: ${stockDisponible}
                               </div>`;
                cantidadInput.after(mensaje);
                $('button[type="submit"]').prop('disabled', true);
            } else {
                if ($('.is-invalid').length === 0) $('button[type="submit"]').prop('disabled', false);
            }
        });
    }

    // --- NUEVO: FILTRADO DE OPCIONES EN EL SELECT DE LA FILA ---
    function filtrarOpcionesFila(row) {
        let materialId = row.find('input[name$="-material"]').val();
        let selectReq = row.find('select[name$="-seleccion_requerimiento"]');
        
        // Si no hay material, no filtramos nada (o podríamos bloquear)
        if (!materialId) return;

        // Obtenemos los requerimientos válidos para este material
        let validReqs = MATS_REQS[materialId] || [];

        // Iteramos las opciones del select
        selectReq.find('option').each(function() {
            let val = $(this).val();
            // Siempre mostramos "Stock Libre" (o valor vacío)
            if (val === 'STOCK_LIBRE' || val === '') {
                $(this).prop('hidden', false);
                return;
            }

            // Si el requerimiento necesita este material, lo mostramos. Si no, lo ocultamos.
            if (validReqs.includes(val)) {
                $(this).prop('hidden', false);
            } else {
                $(this).prop('hidden', true);
            }
        });
    }

    // --- NUEVO: VISIBILIDAD DE CAMPOS ACTIVO FIJO ---
    function actualizarVisibilidadActivos(row) {
        let materialId = row.find('input[name$="-material"]').val();
        let inputsIngreso = row.find('.campo-activo-fijo'); // Marca y Series
        let inputSalida = row.find('.campo-activo-salida'); // Select de Activo
        let esActivoFijo = (materialId && TIPOS_MATERIALES[materialId] === 'ACTIVO_FIJO');
        
        if (esActivoFijo) {
            if (TIPO_ACCION.includes('INGRESO')) {
                inputsIngreso.show();
                inputSalida.hide();
            } else {
                // ES SALIDA
                inputsIngreso.hide();
                inputSalida.show();
                // Forzar cantidad a 1 si es salida de activo fijo
                let cantInput = row.find('input[name$="-cantidad"]');
                if (cantInput.val() == '' || cantInput.val() > 1) cantInput.val(1);
            }
        } else {
            inputsIngreso.hide();
            inputSalida.hide();
            inputSalida.val(''); // Limpiar selección
        }
    }

    // --- SINCRONIZACIÓN CABECERA -> DETALLES ---
    function sincronizarRequerimientos(triggeredByChange = false) {
        let reqCabecera = $('#id_requerimiento').val();
        let filas = $('#form-list tr.item-row');
        
        filas.each(function() {
            let selectReq = $(this).find('select[name$="-seleccion_requerimiento"]');
            
            if (reqCabecera) {
                selectReq.val(reqCabecera);
                // MODIFICADO: Usamos CSS para bloquear visualmente pero permitir el envío del dato (disabled no envía POST)
                selectReq.css({'pointer-events': 'none', 'background-color': '#e9ecef'}); 
                selectReq.prop('tabindex', '-1'); // Evitar foco con tab
            } else {
                // Restaurar estado
                selectReq.css({'pointer-events': 'auto', 'background-color': ''});
                selectReq.prop('tabindex', '');
                
                // Si el usuario cambió la cabecera a "Sin Requerimiento", reseteamos las filas a Stock Libre
                if (triggeredByChange) {
                    selectReq.val('STOCK_LIBRE');
                }

                // NUEVO: Si estamos en modo libre, filtramos las opciones según el material de la fila
                filtrarOpcionesFila($(this));
            }
        });
    }

    $(document).ready(function() {
        // 1. Iniciar lógica visual
        toggleCampos();
        $('#id_tipo').change(function() { toggleCampos(); });

        // Foco inicial en Tipo de Operación al cargar
        $('#id_tipo').focus();

        // Navegación: Enter en Documento Referencia -> Buscador Materiales
        $('#id_documento_referencia').on('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                $('#input_buscar_material').focus();
            }
        });

        // Navegación: Enter en Torre Destino -> Documento Referencia
        $('#id_torre_destino').on('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                $('#id_documento_referencia').focus();
            }
        });

        // 2. LÓGICA DEL BUSCADOR MANUAL (Sin librerías externas)
        const $inputBusqueda = $('#input_buscar_material');
        const $listaResultados = $('#resultados_busqueda');
        let selectedIndex = -1;

        // Evento al escribir
        $inputBusqueda.on('input', function() {
            let query = $(this).val().toLowerCase().trim();
            $listaResultados.empty().hide();
            selectedIndex = -1; // Resetear selección al escribir

            if (query.length < 1) return; // Buscar a partir de 1 letra

            // Obtener filtro de requerimiento actual
            let reqGlobal = $('#id_requerimiento').val();
            let validos = (reqGlobal && REQS_MATERIALES[reqGlobal]) ? REQS_MATERIALES[reqGlobal] : null;

            // Filtrar array en memoria (Texto + Requerimiento)
            let resultados = MATERIALES_DISPONIBLES.filter(m => {
                let matchTexto = m.texto.toLowerCase().includes(query);
                // Si hay requerimiento seleccionado, el material debe estar en su lista
                let matchReq = validos ? validos.includes(m.id) : true;
                return matchTexto && matchReq;
            });

            // Renderizar resultados
            if (resultados.length > 0) {
                resultados.slice(0, 10).forEach(m => { // Mostrar máx 10 resultados
                    let item = `<a href="#" class="list-group-item list-group-item-action item-resultado" 
                                   data-id="${m.id}" data-unidad="${m.unidad}" data-texto="${m.texto}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1 text-codigo fw-bold">${m.codigo}</h6>
                                        <small class="text-muted">${m.unidad}</small>
                                    </div>
                                    <p class="mb-1 small">${m.texto.split(' - ')[1] || m.texto}</p>
                                </a>`;
                    $listaResultados.append(item);
                });
                $listaResultados.show();
            } else {
                let msg = 'No se encontraron materiales.';
                if (validos) {
                    msg = 'No se encuentra el material en el Requerimiento seleccionado.';
                }
                $listaResultados.append('<div class="list-group-item text-muted small">' + msg + '</div>').show();
            }
        });

        // Navegación con Teclado (Flechas, Enter, Tab)
        $inputBusqueda.on('keydown', function(e) {
            let items = $listaResultados.find('.item-resultado');
            if (items.length === 0) {
                if (e.key === 'Enter') e.preventDefault(); // Evitar submit del form si no hay resultados
                return;
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex++;
                if (selectedIndex >= items.length) selectedIndex = 0; // Loop al inicio
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex--;
                if (selectedIndex < 0) selectedIndex = items.length - 1; // Loop al final
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex > -1) items.eq(selectedIndex).click();
            } else if (e.key === 'Tab') {
                if (selectedIndex > -1) {
                    e.preventDefault();
                    items.eq(selectedIndex).click();
                }
            } else if (e.key === 'Escape') {
                $inputBusqueda.val(''); // Limpiar texto
                $listaResultados.hide();
                selectedIndex = -1;
            }
        });

        function updateSelection(items) {
            items.removeClass('active');
            let current = items.eq(selectedIndex);
            current.addClass('active');
            current[0].scrollIntoView({ block: 'nearest' }); // Scroll automático si la lista es larga
        }

        // Evento al hacer clic en un resultado
        $(document).on('click', '.item-resultado', function(e) {
            e.preventDefault();
            let materialId = $(this).data('id');
            let textoMaterial = $(this).data('texto');
            let unidad = $(this).data('unidad');

            // Validar pertenencia al Requerimiento Global (Doble seguridad)
            let reqGlobal = $('#id_requerimiento').val();
            if (reqGlobal && REQS_MATERIALES[reqGlobal]) {
                if (!REQS_MATERIALES[reqGlobal].includes(materialId)) {
                    alert('⛔ BLOQUEO DE VALIDACIÓN\n\nEl material seleccionado NO pertenece al Requerimiento seleccionado en la cabecera.\n\nSi desea ingresar un material extra, cambie la cabecera a "Sin Requerimiento (Stock Libre)".');
                    $inputBusqueda.val('').focus();
                    $listaResultados.hide();
                    return;
                }
            }

            // Validar duplicados
            // MODIFICADO: Solo validamos duplicados estrictos si hay un Requerimiento Global seleccionado.
            // Si es "Stock Libre" (vacío), permitimos agregar el mismo material varias veces para distribuirlo.
            if (reqGlobal) {
                let existe = false;
                $('#form-list input[name$="-material"]').each(function() {
                    if ($(this).val() === materialId && !$(this).closest('tr').is(':hidden')) {
                        alert('Este material ya está en la lista. Al tener un Requerimiento Global seleccionado, no se permiten duplicados.');
                        existe = true;
                        return false;
                    }
                });
                if (existe) {
                    $inputBusqueda.val('').focus();
                    $listaResultados.hide();
                    return;
                }
            }

            // Clonar fila
            let totalFormsInput = $('#id_detalles-TOTAL_FORMS');
            let formCount = parseInt(totalFormsInput.val());
            let templateHtml = $('#empty-form table tbody').html() || $('#empty-form table').html();
            let newRowHtml = templateHtml.replace(/__prefix__/g, formCount);
            let $newRow = $(newRowHtml);
            
            // Rellenar datos visuales y ocultos
            $newRow.find('input[name$="-material"]').val(materialId);
            $newRow.find('.material-nombre').text(textoMaterial);
            $newRow.find('.material-unidad').text(unidad);

            // --- NUEVO: Obtener Precio Unitario (Costo Promedio) ---
            let almacenRef = $('#id_almacen_origen').val() || $('#id_almacen_destino').val() || ALMACEN_ID_URL;
            if (almacenRef && almacenRef !== '00000000-0000-0000-0000-000000000000') {
                $.get(`/logistica/api/stock/${almacenRef}/${materialId}/`, function(data) {
                    if (data.precio) {
                        $newRow.find('input[name$="-costo_unitario"]').val(parseFloat(data.precio).toFixed(2));
                    }
                });
            }
            // -------------------------------------------------------

            $('#form-list').append($newRow);
            totalFormsInput.val(formCount + 1);
            
            // UX: Ocultar mensaje vacío y enfocar cantidad
            $('#empty-message').addClass('d-none');
            $('#form-list tr.item-row').last().find('input[name$="-cantidad"]').focus().select();
            
            // Sincronizar la nueva fila con la cabecera si aplica
            sincronizarRequerimientos();

            // Actualizar visibilidad de campos de Activo Fijo
            actualizarVisibilidadActivos($newRow);

            // Limpiar buscador
            $inputBusqueda.val('');
            $listaResultados.empty().hide(); // Vaciar lista para evitar selección fantasma
            selectedIndex = -1; // Resetear índice
        });

        // Cerrar lista si clic fuera
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.position-relative').length) {
                $listaResultados.hide();
            }
        });

        $('#btn_limpiar_busqueda').click(function() {
            $inputBusqueda.val('').focus();
            $listaResultados.hide();
        });

        // 3. Validar al escribir cantidad
        $(document).on('keyup change', 'input[type="number"]', function() {
            let row = $(this).closest('tr');
            validarStockFila(row);
        });

        // 5. Listener para cambio en Requerimiento de Cabecera
        $('#id_requerimiento').change(function() {
            sincronizarRequerimientos(true);
        });

        // 5.1 NUEVO: Validar duplicados de destino al cambiar el select de la fila
        $(document).on('change', 'select[name$="-seleccion_requerimiento"]', function() {
            let selectActual = $(this);
            let filaActual = selectActual.closest('tr');
            let materialActual = filaActual.find('input[name$="-material"]').val();
            let destinoActual = selectActual.val(); // ID del Req o 'STOCK_LIBRE'

            // Si no hay material o destino, no validamos
            if (!materialActual || !destinoActual) return;

            let duplicado = false;
            $('#form-list tr.item-row').each(function() {
                let filaIteracion = $(this);
                // Ignoramos la fila actual y las ocultas (eliminadas)
                if (filaIteracion.is(filaActual) || filaIteracion.is(':hidden')) return;

                let materialIteracion = filaIteracion.find('input[name$="-material"]').val();
                let destinoIteracion = filaIteracion.find('select[name$="-seleccion_requerimiento"]').val();

                if (materialIteracion === materialActual && destinoIteracion === destinoActual) {
                    duplicado = true;
                    return false; // Break loop
                }
            });

            if (duplicado) {
                alert('⚠️ Atención: Este material ya está asignado a ese mismo destino en otra fila.\n\nPor favor, agrupe las cantidades en una sola línea o seleccione otro destino.');
                // Opcional: Resetear selección si se desea
                // selectActual.val('STOCK_LIBRE'); 
            }
        });

        // 6. BOTÓN ELIMINAR FILA (Mejorado)
        $(document).on('click', '.btn-eliminar-fila', function() {
            let row = $(this).closest('tr');
            let checkboxDelete = row.find('input[name$="-DELETE"]');
            
            // Si la fila tiene un ID (ya existe en BD), marcamos DELETE y ocultamos
            if (row.find('input[name$="-id"]').val()) {
                checkboxDelete.prop('checked', true);
                row.hide();
                row.next('.error-row').hide(); // Ocultar mensaje de error si existe
            } else {
                // Si es nueva, la eliminamos del DOM
                row.next('.error-row').remove();
                row.remove();
            }
            
            // Verificar si quedó vacía la tabla visualmente
            let visibles = $('#form-list tr.item-row:visible').length;
            if (visibles === 0) $('#empty-message').removeClass('d-none');
        });

        // 7. VALIDACIÓN Y LIMPIEZA AL GUARDAR (CRÍTICO PARA EVITAR ERRORES DE FILAS VACÍAS)
        $('form').on('submit', function(e) {
            e.preventDefault(); // Prevenir envío tradicional para usar AJAX

            // A. Limpieza de filas vacías (sin material)
            $('#form-list tr.item-row').each(function() {
                let row = $(this);
                let materialVal = row.find('input[name$="-material"]').val();
                let tieneId = row.find('input[name$="-id"]').val();
                
                // Si no tiene material seleccionado
                if (!materialVal) {
                    if (tieneId) {
                        // Si existe en BD, marcar para borrar
                        row.find('input[name$="-DELETE"]').prop('checked', true);
                        row.hide();
                    } else {
                        // Si es nueva y vacía, eliminar del DOM para que no se envíe
                        row.remove();
                    }
                }
            });

            // B. Reindexar Formset (Indispensable para que Django procese correctamente después de borrar)
            let filas = $('#form-list tr.item-row');
            $('#id_detalles-TOTAL_FORMS').val(filas.length);
            
            filas.each(function(index) {
                // Actualizar name e id de todos los inputs para que sean consecutivos (0, 1, 2...)
                $(this).find(':input').each(function() {
                    let name = $(this).attr('name');
                    if (name) {
                        let newName = name.replace(/detalles-\d+-/, 'detalles-' + index + '-');
                        $(this).attr('name', newName);
                        $(this).attr('id', 'id_' + newName);
                    }
                });
            });

            // D. Validación de Series para Activos Fijos (NUEVO)
            let errorSeries = false;
            $('#form-list tr.item-row').each(function() {
                // Solo validamos filas visibles y que no estén marcadas para borrar
                if ($(this).is(':visible') && !$(this).find('input[name$="-DELETE"]').is(':checked')) {
                    let materialId = $(this).find('input[name$="-material"]').val();
                    let cantidad = parseFloat($(this).find('input[name$="-cantidad"]').val()) || 0;
                    let seriesInput = $(this).find('input[name$="-series_temporales"]');
                    
                    // Si es Activo Fijo y estamos en un Ingreso
                    if (materialId && TIPOS_MATERIALES[materialId] === 'ACTIVO_FIJO' && TIPO_ACCION.includes('INGRESO')) {
                        let textoSeries = seriesInput.val() || "";
                        // Convertir texto "A, B, C" en array ["A", "B", "C"]
                        let listaSeries = textoSeries.split(',').filter(s => s.trim() !== '');
                        
                        if (listaSeries.length !== cantidad) {
                            alert(`⚠️ Error en Activo Fijo:\n\nEstás ingresando ${cantidad} unidades de un Activo Fijo.\nDebes escribir exactamente ${cantidad} series separadas por comas.\n\n(Actualmente hay ${listaSeries.length} series)`);
                            seriesInput.addClass('is-invalid').focus();
                            errorSeries = true;
                            return false; // Romper el bucle each
                        } else {
                            seriesInput.removeClass('is-invalid');
                        }
                    }
                }
            });
            if (errorSeries) {
                return false;
            }

            // C. Validar que quede al menos una fila válida
            let filasValidas = 0;
            $('#form-list tr.item-row').each(function() {
                // Contamos filas visibles que no estén marcadas para eliminar
                if ($(this).is(':visible') && !$(this).find('input[name$="-DELETE"]').is(':checked')) {
                    filasValidas++;
                }
            });

            if (filasValidas === 0) {
                alert('⚠️ Error: Debe agregar al menos un material a la lista antes de guardar.');
                return false;
            }

            // --- ENVÍO AJAX CON TOAST ---
            let $btn = $(this).find('button[type="submit"]');
            let originalText = $btn.html();
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Procesando...');

            let formData = new FormData(this);

            $.ajax({
                url: window.location.href,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                success: function(response) {
                    if (response.success) {
                        // Mostrar Toast de Éxito
                        $('#toast-message').html('<i class="fas fa-check-circle me-2"></i>' + response.message);
                        let toastEl = document.getElementById('liveToast');
                        toastEl.classList.remove('bg-danger');
                        toastEl.classList.add('bg-success');
                        let toast = new bootstrap.Toast(toastEl);
                        toast.show();

                        // Redirigir después de 1.5 segundos
                        setTimeout(function() {
                            window.location.href = response.redirect_url;
                        }, 1500);
                    } else {
                        // Error controlado por el servidor
                        alert('Error: ' + (response.error || 'Ocurrió un error desconocido.'));
                        $btn.prop('disabled', false).html(originalText);
                    }
                },
                error: function(xhr) {
                    // Error de red o validación HTML fallida
                    console.error(xhr.responseText);
                    alert('Error de conexión o validación. Revise los campos.');
                    $btn.prop('disabled', false).html(originalText);
                }
            });
        });

        // 8. NAVEGACIÓN DE FOCO (CANTIDAD -> COSTO -> SELECT -> SIGUIENTE FILA -> BUSCADOR)
        $('#form-list').on('keydown', 'input, select', function(e) {
            // Solo interceptamos Enter y Tab (sin Shift para permitir retroceder)
            if ((e.key === 'Enter' || e.key === 'Tab') && !e.shiftKey) {
                let $this = $(this);
                let $row = $this.closest('tr');
                let name = $this.attr('name');
                let reqGlobal = $('#id_requerimiento').val();
                let $nextRow = $row.nextAll('tr.item-row:visible').first(); // Buscar la siguiente fila visible

                // A. Si estamos en CANTIDAD -> Ir a COSTO
                if (name && name.includes('-cantidad')) {
                    e.preventDefault();
                    $row.find('input[name$="-costo_unitario"]').focus().select();
                }
                
                // B. Si estamos en COSTO
                else if (name && name.includes('-costo_unitario')) {
                    e.preventDefault();
                    // Verificar si es Activo Fijo (Ingreso) -> Ir a MARCA si está visible
                    let inputMarca = $row.find('input[name$="-marca"]');
                    if (inputMarca.is(':visible')) {
                        inputMarca.focus();
                    } else {
                        // Flujo normal (Material Consumible)
                        if (reqGlobal) {
                            if ($nextRow.length > 0) {
                                $nextRow.find('input[name$="-cantidad"]').focus().select();
                            } else {
                                $('#input_buscar_material').focus();
                            }
                        } else {
                            $row.find('select[name$="-seleccion_requerimiento"]').focus();
                        }
                    }
                }

                // C. Si estamos en MARCA -> Ir a SERIES
                else if (name && name.includes('-marca')) {
                    e.preventDefault();
                    $row.find('input[name$="-series_temporales"]').focus();
                }

                // D. Si estamos en SERIES -> Ir a SELECT (o Siguiente)
                else if (name && name.includes('-series_temporales')) {
                    e.preventDefault();
                    if (reqGlobal) {
                        if ($nextRow.length > 0) {
                            $nextRow.find('input[name$="-cantidad"]').focus().select();
                        } else {
                            $('#input_buscar_material').focus();
                        }
                    } else {
                        $row.find('select[name$="-seleccion_requerimiento"]').focus();
                    }
                }

                // E. Si estamos en SELECT -> Ir a Siguiente Fila o Buscador
                else if (name && name.includes('-seleccion_requerimiento')) {
                    e.preventDefault();
                    if ($nextRow.length > 0) {
                        $nextRow.find('input[name$="-cantidad"]').focus().select();
                    } else {
                        $('#input_buscar_material').focus();
                    }
                }
            }
        });

        // LÓGICA DE INICIO: Forzar "Stock Libre" solo en creación limpia (Nueva Operación)
        let isEdit = "{{ form.instance.pk|default:'' }}" !== "";
        let hasErrors = {% if form.errors or formset.errors %}true{% else %}false{% endif %};
        let reqCabecera = $('#id_requerimiento').val();

        if (!isEdit && !hasErrors && reqCabecera === '') {
             sincronizarRequerimientos(true); // true = Forzar cambio a Stock Libre
        } else {
             sincronizarRequerimientos(false); // false = Respetar lo que venga (Edición o Error)
        }

        // Inicializar visibilidad de activos fijos para filas existentes (Edición)
        $('#form-list tr.item-row').each(function() {
            actualizarVisibilidadActivos($(this));
        });

        // --- LÓGICA BUSCADOR TRABAJADORES (AUTOFILTRO) ---
        const $inputTrabajador = $('#input_buscar_trabajador');
        const $resTrabajador = $('#resultados_trabajador');
        const $selectTrabajador = $('#id_trabajador');
        let selectedIndexTrabajador = -1;

        // 1. Inicializar valor si estamos editando (Leemos el texto del select renderizado por Django)
        let $opcionInicial = $selectTrabajador.find('option:selected');
        if ($opcionInicial.val()) {
            $inputTrabajador.val($opcionInicial.text());
        }

        // 2. Evento de Búsqueda con Debounce (Retardo)
        let timeoutBusqueda = null;

        $inputTrabajador.on('input focus', function() {
            let q = $(this).val().toUpperCase();
            $resTrabajador.empty().hide();
            selectedIndexTrabajador = -1;
            
            if (q.length < 1) return; // Buscar desde 1 letra

            clearTimeout(timeoutBusqueda);
            
            timeoutBusqueda = setTimeout(() => {
                $.get("{% url 'api_buscar_trabajador' %}", { q: q }, function(data) {
                    $resTrabajador.empty();
                    
                    if (data.results && data.results.length > 0) {
                        data.results.forEach(t => {
                            let nombreCompleto = `${t.nombres} ${t.apellidos}`;
                            let item = `<a href="#" class="list-group-item list-group-item-action item-trabajador" data-id="${t.id}" data-texto="${nombreCompleto} (${t.dni})">
                                <div class="fw-bold text-dark">${nombreCompleto}</div>
                                <small class="text-muted"><i class="fas fa-id-card me-1"></i>${t.dni}</small>
                            </a>`;
                            $resTrabajador.append(item);
                        });
                        $resTrabajador.show();
                    } else {
                        $resTrabajador.append('<div class="list-group-item text-muted small">No encontrado. Use el botón (+) para crear.</div>').show();
                    }
                });
            }, 300); // Esperar 300ms después de dejar de escribir
        });

        // Navegación con Teclado para Trabajadores
        $inputTrabajador.on('keydown', function(e) {
            let items = $resTrabajador.find('.item-trabajador');
            if (items.length === 0) {
                if (e.key === 'Enter') e.preventDefault(); 
                return;
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndexTrabajador++;
                if (selectedIndexTrabajador >= items.length) selectedIndexTrabajador = 0;
                updateSelectionTrabajador(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndexTrabajador--;
                if (selectedIndexTrabajador < 0) selectedIndexTrabajador = items.length - 1;
                updateSelectionTrabajador(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndexTrabajador > -1) items.eq(selectedIndexTrabajador).click();
            } else if (e.key === 'Tab') {
                if (selectedIndexTrabajador > -1) {
                    e.preventDefault();
                    items.eq(selectedIndexTrabajador).click();
                }
            } else if (e.key === 'Escape') {
                $inputTrabajador.val('');
                $resTrabajador.hide();
                selectedIndexTrabajador = -1;
            }
        });

        function updateSelectionTrabajador(items) {
            items.removeClass('active');
            let current = items.eq(selectedIndexTrabajador);
            current.addClass('active');
            current[0].scrollIntoView({ block: 'nearest' });
        }

        // 3. Evento Selección
        $(document).on('click', '.item-trabajador', function(e){
            e.preventDefault();
            let id = $(this).data('id');
            let texto = $(this).data('texto');
            
            // Crear opción dinámica si no existe (porque el select carga vacío)
            if ($selectTrabajador.find("option[value='" + id + "']").length == 0) {
                $selectTrabajador.append(new Option(texto, id, true, true));
            }
            
            $selectTrabajador.val(id).trigger('change');
            $inputTrabajador.val(texto); // Actualizar input visual
            $resTrabajador.hide();

            // Foco automático: Si hay Torre visible -> Torre, sino -> Documento
            if ($('#id_torre_destino').is(':visible')) {
                $('#id_torre_destino').focus();
            } else {
                $('#id_documento_referencia').focus();
            }
        });

        // 4. Cerrar al hacer clic fuera
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.input-group').length) {
                $resTrabajador.hide();
            }
        });

        // --- LÓGICA MODAL NUEVO TRABAJADOR ---
        $('#btn-save-trabajador').click(function() {
            let btn = $(this);
            let form = $('#form-quick-trabajador');
            let errorDiv = $('#msg-error-trabajador');
            
            // Limpiar errores previos
            errorDiv.addClass('d-none').text('');
            
            // Validar campos básicos HTML5
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            btn.prop('disabled', true).text('Guardando...');

            $.post("{% url 'api_crear_trabajador' %}", form.serialize() + "&csrfmiddlewaretoken={{ csrf_token }}", function(data) {
                if (data.success) {
                    // 1. Agregar opción al select y seleccionarla
                    let newOption = new Option(data.text, data.id, true, true);
                    $('#id_trabajador').append(newOption).trigger('change');
                    
                    // 1.1 Actualizar también el input visual del buscador
                    $('#input_buscar_trabajador').val(data.text);
                    
                    // 2. Cerrar modal y limpiar
                    $('#modalNuevoTrabajador').modal('hide');
                    form[0].reset();
                } else {
                    errorDiv.removeClass('d-none').text(data.error);
                }
            }).fail(function() {
                errorDiv.removeClass('d-none').text('Error de conexión con el servidor.');
            }).always(function() {
                btn.prop('disabled', false).text('Guardar y Seleccionar');
            });
        });

        // 9. GUARDAR CON CTRL+ENTER (Global)
        $(document).on('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                $('button[type="submit"]').first().click();
            }
        });
    });
</script>
{% endblock %}