{% extends "base.html" %}

{% block title %}Inventario Físico{% endblock %}
{% block header %}Inventario Físico por Almacén{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" action=""> <div class="input-group">
                        <input type="text" name="q" class="form-control" 
                            placeholder="Buscar material por nombre o código..." 
                            value="{{ busqueda|default:'' }}" autofocus> 
                        
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        
                        <a href="{% url 'exportar_inventario_excel' %}?q={{ busqueda|default:'' }}" class="btn btn-success" title="Descargar Excel">
                            <i class="fas fa-file-excel"></i> Exportar
                        </a>

                        <a href="{% url 'exportar_activos_externos_excel' %}" class="btn btn-danger ms-1" title="Ver equipos devueltos a Lima">
                            <i class="fas fa-building"></i> En Sede Central
                        </a>

                        {% if user.is_staff or user.is_superuser %}
                        <a href="{% url 'importar_datos_excel' %}" class="btn btn-dark ms-1" title="Carga Masiva (Catálogo y Activos)">
                            <i class="fas fa-file-import"></i> Importar
                        </a>
                        {% endif %}

                        {% if busqueda %}
                        <a href="{% url 'inventario_list' %}" class="btn btn-outline-secondary" title="Limpiar filtro">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <div class="accordion" id="accordionAlmacenes">
            {% for almacen in almacenes %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ almacen.id }}">
                    <button class="accordion-button {% if not forloop.first and not busqueda %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ almacen.id }}" aria-expanded="{% if forloop.first or busqueda %}true{% else %}false{% endif %}" aria-controls="collapse{{ almacen.id }}">
                        <strong>{{ almacen.nombre }}</strong> 
                        <span class="badge bg-secondary ms-2">{{ almacen.stocks.all|length }} Ítems</span>
                    </button>
                </h2>
                <div id="collapse{{ almacen.id }}" class="accordion-collapse collapse {% if forloop.first or busqueda %}show{% endif %}" data-bs-parent="#accordionAlmacenes">
                    <div class="accordion-body p-0">
                        <div class="d-flex justify-content-end p-3 bg-light border-bottom">
                            <span class="align-self-center me-3 text-muted small">Acciones Rápidas:</span>
    
                            <a href="{% url 'operacion_almacen' 'ingreso' almacen.id %}" class="btn btn-success btn-sm me-2">
                                <i class="fas fa-download me-1"></i> Recepcionar
                            </a>
    
                            <a href="{% url 'operacion_almacen' 'salida' almacen.id %}" class="btn btn-danger btn-sm">
                                <i class="fas fa-upload me-1"></i> Despachar a Torre
                            </a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Código</th>
                                        <th>Material</th>
                                        <th>Categoría</th>
                                        <th>Ubicación</th>
                                        <th class="text-end">Stock Actual</th>
                                        <th class="text-center">Unidad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in almacen.stocks.all %}
                                    <tr>
                                        <td><span class="badge bg-light text-dark border">{{ item.material.codigo }}</span></td>
                                        <td>
                                            <a href="{% url 'kardex_producto' almacen.id item.material.id %}" class="fw-bold text-decoration-none">
                                                {{ item.material.descripcion }} <i class="fas fa-search-plus small ms-1 opacity-50"></i>
                                            </a>
                                        </td>
                                        <td>{{ item.material.categoria.nombre }}</td>
                                        <td>{{ item.ubicacion_pasillo|default:"-" }}</td>
                                        
                                        <td class="text-end fw-bold 
                                            {% if item.estado_alerta == 'CRITICO' %}text-danger
                                            {% elif item.estado_alerta == 'ADVERTENCIA' %}text-warning
                                            {% else %}text-success{% endif %}">
                                            {{ item.cantidad }}
                                            {% if item.cantidad_minima > 0 %}
                                                <br>
                                                <small class="text-muted fw-normal" style="font-size: 0.75rem;">Mín: {{ item.cantidad_minima|floatformat:0 }}</small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">{{ item.material.unidad_medida }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center py-3 text-muted">
                                            Este almacén está vacío.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>
</div>
{% endblock %}